#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'add_master'
require 'fileutils'

DEBUG = true
#DEBUG = false

SSH_PORT = 10022

begin
  if ARGV.size != 2 && ARGV.size != 1
    raise "USAGE: #{$0} example.com [192.168.100.100] \n"
  end

  add_master = AddMaster.new("/etc/addzone.conf")
  domain  = ARGV[0]
  add_master.ip_address = ARGV[1] if ARGV.size == 2

  puts "Domain   : #{domain}"
  puts "IP Adress: #{add_master.ip_address}"

  add_master.add_zone(domain)
  add_master.named_checkconf
  add_master.reload

  add_master.name_servers[1..-1].each do |server|
    ssh = "ssh -p #{SSH_PORT} root@#{server} addslave #{domain}"
    puts ssh
    puts `#{ssh}`
    check_dns = "checkdns #{server} #{domain}"
    puts check_dns
    puts `#{check_dns}`
  end

rescue => error
  puts "ERROR: " + error
end
