#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'add_master'
require 'fileutils'

DEBUG = true
#DEBUG = false

SSH_PORT = 10022

begin
  if ARGV.size != 2 && ARGV.size != 1
    raise "USAGE: #{$0} example.com [192.168.100.100] \n"
  end

  add_master = AddMaster.new("/etc/addzone.conf")
  domain  = ARGV[0]
  add_master.ip_address = ARGV[1] if ARGV.size == 2

  puts "Domain   : #{domain}"
  puts "IP Adress: #{add_master.ip_address}"

  add_master.add_zone(domain)

  checkconf = "/usr/sbin/named-checkconf  -t /var/named/chroot/ /etc/named.conf"
  puts checkconf

  unless DEBUG
    puts `#{checkconf}`
    raise 'ERROR: named-checkconf failed' if $? != 0
  end

  rndc_reload = "/usr/sbin/rndc reload"
  puts rndc_reload

  unless DEBUG
    puts `#{rndc_reload}`
    raise 'ERROR: rndc reload failed' if $? != 0
  end

  HOSTS[1..-1].each do |host|
    ns2 = "ssh -p #{SSH_PORT} root@#{host} addslave #{domain}"
    puts ns2
    puts `#{ns2}` unless DEBUG
  end

  sleep 1 unless DEBUG
  check_dns = "checkdns #{domain}"
  puts check_dns
  puts `#{check_dns}` unless DEBUG
rescue => error
  puts
  puts $0 + ": " + error
end
